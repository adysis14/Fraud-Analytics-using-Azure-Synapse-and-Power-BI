{
	"name": "ingestion script",
	"properties": {
		"content": {
			"query": "CREATE SCHEMA synapse\n\nCREATE MASTER KEY ENCRYPTION BY PASSWORD = 'Test@123456'\n\n----------------------------------------------------------\n----------------------------------------------------------\nCREATE DATABASE SCOPED CREDENTIAL AzureStorageAccountKey\nWITH IDENTITY='ccfraudstac',\nSECRET='z60ZItemcMp4zHvXVoyIf8Fyb0OqBm4Wo7r327wEBCBAfVn593ij5pjGtH8UY8UMF3/eZC/SGkU9+AStcpSPow==';\n\n----------------------------------------------------------\n----------------------------------------------------------\n\nCREATE EXTERNAL DATA SOURCE CSVDataSource WITH\n(\nTYPE= HADOOP,\nLOCATION='wasbs://files@ccfraudstac.blob.core.windows.net', \nCREDENTIAL= AzureStorageAccountKey\n);\n\n----------------------------------------------------------\n----------------------------------------------------------\n\nCREATE EXTERNAL FILE FORMAT CSVFileFormat\nWITH (\n    FORMAT_TYPE= DELIMITEDTEXT, \n    FORMAT_OPTIONS (\n        FIELD_TERMINATOR = ',',\n        STRING_DELIMITER = '''',\n        FIRST_ROW = 2,\n        USE_TYPE_DEFAULT= TRUE\n    )\n);\nGO \n\nCREATE EXTERNAL FILE FORMAT csv\nWITH (\n   FORMAT_TYPE = DELIMITEDTEXT,\n   FORMAT_OPTIONS (\n      FIELD_TERMINATOR =',',\n      STRING_DELIMITER ='',\n      DATE_FORMAT = '',\n      USE_TYPE_DEFAULT = False\n   )\n);\nGO\n\n----------------------------------------------------------\n----------------------------------------------------------\n\nCREATE EXTERNAL TABLE synapse.exCreditCard\n(\n        [Time] float,\n        [V1] float,[V2] float,[V3] float,[V4] float,[V5] float,[V6] float,[V7] float,[V8] float,[V9] float,[V10] float,\n        [V11] float,[V12] float,[V13] float,[V14] float,[V15] float,[V16] float,[V17] float,[V18] float,[V19] float,[V20] float,\n        [V21] float,[V22] float,[V23] float,[V24] float,[V25] float,[V26] float,[V27] float,[V28] float,\n        [Amount] float,[Class] bigint,[id] bigint\n)\nWITH\n(\n        LOCATION = 'CreditCard.csv',\n        DATA_SOURCE = [CSVDataSource],\n        FILE_FORMAT = [CSVFileFormat]\n);\nGO\n\nCREATE EXTERNAL TABLE synapse.[MLModelExt]\n(\n[Model] [varbinary](max) NULL\n)\nWITH\n(\n    LOCATION='credit_card_model.onnx.hex' ,\n    DATA_SOURCE = [CSVDataSource] ,\n    FILE_FORMAT = csv ,\n    REJECT_TYPE = VALUE ,\n    REJECT_VALUE = 0\n);\nGO\n\n----------------------------------------------------------\n----------------------------------------------------------\n\nDECLARE @modelexample varbinary(max)= (SELECT [Model] FROM synapse.[MLModelExt]);\n\nSELECT\nd.*, p.*\nINTO synapse.CreditCard\nFROM PREDICT(MODEL= @modelexample,\nDATA = synapse.exCreditCard AS d,\nRUNTIME = ONNX) WITH (output_label bigint) AS p;\n\n----------------------------------------------------------\n----------------------------------------------------------\n\nCREATE VIEW dbo.CreditCardIonIat As\nSELECT\n   credit.Time,\n   city.name,\n   city.Ion,\n   city.Iat,\n   city.alpha2,\n   country.companyen,\n   credit.V1,\n   credit.V2,\n   credit.V3,\n   credit.V4,\n   credit.V5,\n   credit.V6,\n   credit.V7,\n   credit.V8,\n   credit.V9,\n   credit.V10,\n   credit.V11,\n   credit.V12,\n   credit.V13,\n   credit.V14,\n   credit.V15,\n   credit.V16,\n   credit.V17,\n   credit.V18,\n   credit.V19,\n   credit.V20,\n   credit.V21,\n   credit.V22,\n   credit.V23,\n   credit.V24,\n   credit.V25,\n   credit.V26,\n   credit.V27,\n   credit.V28,\n   credit.Amount,\n   credit.Class,\n   credit.id\nFROM\nOPENROWSET(\n   BULK 'https://synapselabfraud###.blob.core.windows.net/synapse/CreditCardScored.csv' ,\n    FORMAT = 'CSV',\n    FIELDTERMINATOR = ',',\n    FIRSTROW = 2,\n    ESCAPECHAR = '\\\\'\n)\nWITH (\n[Time] float,\n[V1] float,[V2] float,[V3] float,[V4] float,[V5] float,[V6] float,[V7] float,[V8] float,[V9] float,[V10] float,\n[V11] float,[V12] float,[V13] float,[V14] float,[V15] float,[V16] float,[V17] float,[V18] float,[V19] float,[V20] float, [V21] float,[V22] float,[V23] float,[V24] float,[V25] float,[V26] float,[V27] float,[V28] float, [Amount] float,[Class] int,[id] varchar(20)\n) AS [credit]\nLEFT JOIN\nOPENROWSET(\nBULK 'https://synapselabfraud###.dfs.core.windows.net/synapse/CityList.csv',\nFORMAT = 'CSV',\nFIELDTERMINATOR=',',\nFIRSTROW = 2,\nESCAPECHAR= '\\\\'\n)\nWITH (\n[id] VARCHAR (20),\n[name] VARCHAR (100) COLLATE Latin1_General_100_CI_AI_SC_UTF8,\n[state] VARCHAR (10),\n[alpha2] VARCHAR (2),\n[Ion] float,\n[Iat] float\n) AS [city] ON\ncredit.id = city.id\nLEFT JOIN\nOPENROWSET(\nBULK 'https://synapselabfraud###.dfs.core.windows.net/synapse/CountryList.csv',\nFORMAT = 'CSV',\nFIELDTERMINATOR=',',\nFIRSTROW = 2,\nESCAPECHAR = '\\\\'\n)\nWITH (\n[companyip] VARCHAR (20) COLLATE Latin1_General_100_CI_AI_SC_UTF8,\n[companycen] VARCHAR (100) COLLATE Latin1_General_100_CI_AI_SC_UTF8,\n[numeric] decimal,\n[alpha3] VARCHAR (3),\n[alpha2] VARCHAR (2),\n[location] VARCHAR (100) COLLATE Latin1_General_100_CI_ AI_SC_UTF8,\n[subdivision] VARCHAR (15) COLLATE Latin1_General_100_CI_AI_SC_UTF8\n) AS [country] ON\ncity.alpha2 = country.alpha2\n\n----------------------------------------------------------\n----------------------------------------------------------",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "dedicatedSqlPool",
				"poolName": "dedicatedSqlPool"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}